<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MARSOCIAL</title>
  <style>
    /* ============================
       Estilos Generales y Layout
       ============================ */
    body {
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 0;
      transition: background 0.3s, color 0.3s;
    }
    /* Tema oscuro: fondo oscuro y texto blanco puro */
    body.dark {
      background: #121212;
      color: #ffffff;
    }
    /* Para bloques en modo oscuro */
    body.dark .post,
    body.dark .create-post,
    body.dark #profileStats,
    body.dark .friends-list,
    body.dark .friend-requests,
    body.dark .messages-list,
    body.dark .notifications-list {
      background: #2a2a2a;
      color: #ffffff;
      border-color: #444;
    }
    /* Para los modales en modo oscuro */
    body.dark .modal-content {
      background: #2a2a2a;
      color: #ffffff;
      border-color: #444;
    }
    /* Header fijo */
    header {
      background: #1877f2;
      color: white;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
    }
    header h1 { margin: 0; }
    nav ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      align-items: center;
    }
    nav ul li { margin: 0 10px; }
    nav ul li a {
      color: white;
      text-decoration: none;
      cursor: pointer;
    }
    /* El ul de navegación */
    #navList {
      display: flex;
      align-items: center;
    }
    /* Contenedor para botones y perfil */
    #headerRight {
      display: flex;
      align-items: center;
      margin-right: 20px;
    }
    #userActions button {
      margin-right: 10px;
      padding: 5px 10px;
      border: none;
      border-radius: 3px;
      background: white;
      color: #1877f2;
      cursor: pointer;
    }
    /* Icono de perfil */
    #profileIcon {
      cursor: pointer;
    }
    #profileIcon img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }
    /* Dropdown de perfil (right: 60px para que no se corte) */
    #profileDropdown {
      display: none;
      position: absolute;
      right: 60px;
      top: 60px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-shadow: 0px 2px 5px rgba(0,0,0,0.3);
    }
    #profileDropdown ul {
      list-style: none;
      padding: 10px;
      margin: 0;
    }
    #profileDropdown ul li {
      margin-bottom: 5px;
    }
    #profileDropdown ul li a {
      text-decoration: none;
      color: #1877f2;
      cursor: pointer;
    }
    /* Contenedor principal */
    .container {
      max-width: 1200px;
      margin: 80px auto 20px auto;
      display: flex;
    }
    .sidebar {
      width: 25%;
      padding: 10px;
    }
    .main-content {
      width: 75%;
      padding: 10px;
    }
    .section { display: none; }
    .active { display: block; }
    
    /* ======================
       Estilos para Publicaciones y Formularios
       ====================== */
    .create-post {
      background: white;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 5px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .create-post input[type="text"],
    .create-post textarea,
    .create-post select {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }
    .create-post input[type="file"] {
      margin-bottom: 10px;
    }
    .create-post button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      color: white;
    }
    /* Indicador de carga */
    #loadingIndicator {
      margin-top: 5px;
      font-weight: bold;
    }
    .post {
      background: white;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 5px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .post-header {
      display: flex;
      align-items: center;
    }
    .post-header img {
      border-radius: 50%;
      width: 40px;
      height: 40px;
      margin-right: 10px;
    }
    .btn {
      padding: 5px 10px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      margin-right: 5px;
    }
    .btn-primary { background: #1877f2; color: white; }
    .btn-secondary { background: #ccc; color: black; }
    .btn-danger { background: red; color: white; }
    
    /* ====================
       Estilos de Modales
       ==================== */
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background: rgba(0,0,0,0.5);
    }
    .modal-content {
      background: white;
      margin: 10% auto;
      padding: 20px;
      border-radius: 5px;
      width: 300px;
      position: relative;
    }
    .close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 20px;
      cursor: pointer;
    }
    form {
      display: flex;
      flex-direction: column;
    }
    form input, form textarea, form select {
      margin-bottom: 10px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    form button {
      background: #1877f2;
      border: none;
      padding: 10px;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    
    /* ==========================
       Secciones de Amigos, Mensajes y Notificaciones
       ========================== */
    .friends-list, .friend-requests, .messages-list, .notifications-list {
      background: white;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 10px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .friends-list li, .friend-requests li, .messages-list li, .notifications-list li {
      margin-bottom: 5px;
    }
    
    /* Controles para ordenar el Feed */
    #feedOrderControls {
      margin-bottom: 10px;
      display: flex;
    }
    .order-btn {
      flex: 1;
      text-align: center;
      white-space: nowrap;
      padding: 5px 10px;
      margin-right: 5px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      background: #1877f2;
      color: white;
    }
    .order-btn.active {
      background: darkblue;
    }
    .order-btn:disabled {
      background: gray;
      cursor: not-allowed;
    }
    
    /* Sidebar: Perfil resumido y amigos recomendados */
    #profileSummary {
      text-align: center;
    }
    #profileSummary img {
      border-radius: 50%;
      width: 80px;
      height: 80px;
    }
    #profileFollowers {
      margin: 5px 0;
    }
    #profileStats {
      background: white;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    /* Amigos recomendados en el sidebar */
    #friendSuggestions h3 {
      margin-bottom: 5px;
    }
    #noFriendsText {
      font-size: 0.8em;
      color: #666;
      display: none;
    }
  </style>
</head>
<body>
  <!-- Encabezado -->
  <header>
    <h1>MARSOCIAL</h1>
    <nav>
      <ul id="navList">
        <li><a onclick="navigate('home')">Inicio</a></li>
        <li><a onclick="navigate('profile')">Perfil</a></li>
        <li><a onclick="navigate('friends')">Amigos</a></li>
        <li><a onclick="navigate('messages')">Mensajes</a></li>
        <li><a onclick="navigate('notifications')">Notificaciones</a></li>
      </ul>
    </nav>
    <!-- Contenedor para botones y perfil -->
    <div id="headerRight">
      <div id="userActions">
        <button onclick="openModal('loginModal')">Login</button>
        <button onclick="openModal('registerModal')">Registro</button>
      </div>
      <div id="profileIcon">
        <img id="profileIconImg" src="https://cdn-icons-png.flaticon.com/512/6326/6326055.png" alt="Icono de perfil">
      </div>
    </div>
    <!-- Dropdown de perfil -->
    <div id="profileDropdown">
      <ul>
        <li><a href="#" onclick="showProfileStatistics()">Estadísticas</a></li>
        <li><a href="#" onclick="showConfiguration()">Configuración</a></li>
        <li><a href="#" onclick="logout()">Cerrar sesión</a></li>
      </ul>
    </div>
  </header>
  
  <!-- Contenedor principal -->
  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div id="profileSummary" style="display:none;">
        <img src="https://cdn-icons-png.flaticon.com/512/6326/6326055.png" id="profilePic" alt="Foto de perfil">
        <h3 id="profileName"></h3>
        <p id="profileBio"></p>
        <p id="profileFollowers"></p>
      </div>
      <div id="friendSuggestions">
        <h3>Amigos recomendados</h3>
        <small id="noFriendsText"></small>
        <ul id="suggestionsList"></ul>
      </div>
    </div>
    
    <!-- Área principal -->
    <div class="main-content">
      <!-- Sección Inicio -->
      <div id="home" class="section active">
        <div class="create-post" id="createPostSection">
          <h3>Crear Publicación</h3>
          <form id="postForm">
            <input type="text" id="postTitle" placeholder="Título de la publicación (1-50 caracteres)" required>
            <textarea id="postDescription" rows="3" placeholder="Descripción (1-500 caracteres)" required></textarea>
            <!-- Solo se permite subir imágenes -->
            <select id="postMediaType">
              <option value="">Sin medio (opcional)</option>
              <option value="imagen">Imagen</option>
            </select>
            <label>Subir archivo (opcional):</label>
            <input type="file" id="postFile" accept="image/*">
            <input type="text" id="postMediaURL" placeholder="URL de la imagen (opcional)">
            <button type="button" id="publishButton" style="background: black;" disabled onclick="publishPost()">Publicar</button>
            <div id="loadingIndicator" style="display:none;"></div>
          </form>
        </div>
        <div id="feedOrderControls">
          <button class="order-btn" data-order="todo" onclick="setFeedOrder('todo')">Todo</button>
          <button class="order-btn" data-order="siguiendo" onclick="setFeedOrder('siguiendo')">Siguiendo</button>
          <button class="order-btn" data-order="amigos" onclick="setFeedOrder('amigos')">Publicaciones de mis amigos</button>
          <button class="order-btn" data-order="mias" onclick="setFeedOrder('mias')">Mis publicaciones</button>
        </div>
        <div id="feed"></div>
      </div>
      
      <!-- Sección Perfil -->
      <div id="profile" class="section">
        <h2>Mi Perfil</h2>
        <div id="profileStats"></div>
        <h3>Editar Perfil</h3>
        <form onsubmit="updateProfile(event)">
          <input type="text" id="editName" placeholder="Nombre" maxlength="50">
          <textarea id="editBio" placeholder="Biografía" maxlength="150"></textarea>
          <label>Actualizar imagen de perfil:</label>
          <input type="file" id="profileImageInput" accept="image/*">
          <label>
            <input type="checkbox" id="editVerified">
            Verificado
          </label>
          <button type="submit">Actualizar</button>
        </form>
        <h3>Tus Publicaciones</h3>
        <div id="myPosts"></div>
      </div>
      
      <!-- Sección Amigos -->
      <div id="friends" class="section">
        <h2>Mis Amigos</h2>
        <ul id="friendsList" class="friends-list"></ul>
        <div id="sendFriendRequestSection">
          <h3>Enviar solicitud de amistad</h3>
          <input type="text" id="friendRequestUsername" placeholder="Nombre de usuario">
          <button onclick="sendFriendRequestByUsername()">Enviar solicitud de amistad</button>
        </div>
        <div id="friendPosts"></div>
      </div>
      
      <!-- Sección Mensajes -->
      <div id="messages" class="section">
        <h2>Mensajes</h2>
        <ul id="messagesList" class="messages-list"></ul>
        <h3>Nuevo Mensaje</h3>
        <form onsubmit="sendMessage(event)">
          <input type="text" id="msgRecipient" placeholder="Usuario destinatario">
          <textarea id="msgContent" placeholder="Tu mensaje"></textarea>
          <button type="submit">Enviar</button>
        </form>
      </div>
      
      <!-- Sección Notificaciones -->
      <div id="notifications" class="section">
        <h2>Notificaciones</h2>
        <ul id="notificationsList" class="notifications-list"></ul>
      </div>
    </div>
  </div>
  
  <!-- Modal Login -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('loginModal')">&times;</span>
      <h3>Iniciar Sesión</h3>
      <form onsubmit="login(event)">
        <input type="text" id="loginUsername" placeholder="Usuario" required>
        <input type="password" id="loginPassword" placeholder="Contraseña" required>
        <button type="submit">Entrar</button>
      </form>
    </div>
  </div>
  
  <!-- Modal Registro -->
  <div id="registerModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('registerModal')">&times;</span>
      <h3>Registro</h3>
      <form onsubmit="register(event)">
        <input type="text" id="regUsername" placeholder="Nombre de usuario" required>
        <input type="password" id="regPassword" placeholder="Contraseña" required>
        <input type="text" id="regName" placeholder="Nombre completo" required maxlength="50">
        <textarea id="regBio" placeholder="Biografía" maxlength="150"></textarea>
        <button type="submit">Registrarse</button>
      </form>
    </div>
  </div>
  
  <!-- Modal Estadísticas -->
  <div id="statsModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeStatsModal()">&times;</span>
      <div id="statsContent"></div>
      <button onclick="closeStatsModal()">Volver</button>
    </div>
  </div>
  
  <!-- Modal Configuración -->
  <div id="configModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeConfigModal()">&times;</span>
      <h3>Configuración</h3>
      <button onclick="showThemeOptions()">Tema</button>
      <button onclick="confirmDeleteAccount()">Borrar cuenta</button>
      <button onclick="closeConfigModal()">Volver</button>
    </div>
  </div>
  
  <!-- Modal Tema -->
  <div id="themeModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeThemeModal()">&times;</span>
      <h3>Selecciona Tema</h3>
      <button onclick="setTheme('light', true)">Claro</button>
      <button onclick="setTheme('dark', true)">Oscuro</button>
      <button onclick="setTheme('system', true)">Sistema</button>
      <button onclick="closeThemeModal()">Volver</button>
    </div>
  </div>
  
  <script>
    /***************************************
     * UTILIDADES
     ***************************************/
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }
    
    /***************************************
     * SIMULACIÓN DE "BASE DE DATOS" CON localStorage
     ***************************************/
    let currentUser = null;
    let feedOrder = "todo";
    
    function initData() {
      if (!localStorage.getItem('users')) {
        // Agregamos también un usuario MARIOGAMES por defecto
        const users = [
          { id: 1, username: 'user1', password: 'pass1', name: 'Usuario Uno', bio: 'Bio de usuario uno', verified: false, friends: [2], friendRequests: [], profilePic: '', removedSuggestions: [], createdAt: Date.now(), following: [], followers: [] },
          { id: 2, username: 'user2', password: 'pass2', name: 'Usuario Dos', bio: 'Bio de usuario dos', verified: false, friends: [1], friendRequests: [], profilePic: '', removedSuggestions: [], createdAt: Date.now(), following: [], followers: [] },
          { id: 3, username: 'MARIOGAMES', password: 'secret', name: 'Mario Games', bio: 'Verificado', verified: false, friends: [], friendRequests: [], profilePic: '', removedSuggestions: [], createdAt: Date.now(), following: [], followers: [] }
        ];
        localStorage.setItem('users', JSON.stringify(users));
      }
      if (!localStorage.getItem('posts')) {
        localStorage.setItem('posts', JSON.stringify([]));
      }
      if (!localStorage.getItem('messages')) {
        localStorage.setItem('messages', JSON.stringify([]));
      }
      if (!localStorage.getItem('notifications')) {
        localStorage.setItem('notifications', JSON.stringify([]));
      }
      let savedTheme = localStorage.getItem("theme") || "light";
      setTheme(savedTheme, false);
    }
    
    function getUsers() { return JSON.parse(localStorage.getItem('users')) || []; }
    function saveUsers(users) { localStorage.setItem('users', JSON.stringify(users)); }
    function getPosts() { return JSON.parse(localStorage.getItem('posts')) || []; }
    function savePosts(posts) {
      try {
        localStorage.setItem('posts', JSON.stringify(posts));
      } catch (e) {
        if (e.name === 'QuotaExceededError') {
          alert("Error: se ha excedido la cuota de almacenamiento para las publicaciones.");
        }
        console.error(e);
      }
    }
    function getMessages() { return JSON.parse(localStorage.getItem('messages')) || []; }
    function saveMessages(messages) { localStorage.setItem('messages', JSON.stringify(messages)); }
    function getNotifications() { return JSON.parse(localStorage.getItem('notifications')) || []; }
    function saveNotifications(notifications) { localStorage.setItem('notifications', JSON.stringify(notifications)); }
    
    /***************************************
     * Función para mostrar nombre y verificado
     ***************************************/
    function getUserDisplayName(user) {
      if (!user) return "Usuario";
      let name = user.name;
      // Ahora se muestra el icono de verificado únicamente si el usuario ha marcado la opción en su perfil.
      if (user.verified) {
        name += ' <img src="https://cdn-icons-png.flaticon.com/512/7595/7595571.png" style="width:20px; height:auto; vertical-align:middle;">';
      }
      return name;
    }
    
    /***************************************
     * Navegación entre secciones
     ***************************************/
    function navigate(section) {
      if (!currentUser && section !== "home" && section !== "notifications") {
        alert("Debes iniciar sesión para acceder a esta sección");
        return;
      }
      document.querySelectorAll(".section").forEach(sec => sec.classList.remove("active"));
      document.getElementById(section).classList.add("active");
      if (section === "home") loadFeed();
      if (section === "profile") { loadMyPosts(); updateProfileStats(); }
      if (section === "friends") loadFriends();
      if (section === "messages") loadMessages();
      if (section === "notifications") loadNotifications();
    }
    
    /***************************************
     * Abrir/Cerrar modales
     ***************************************/
    function openModal(id) { document.getElementById(id).style.display = "block"; }
    function closeModal(id) { document.getElementById(id).style.display = "none"; }
    
    /***************************************
     * Autenticación
     ***************************************/
    function login(event) {
      event.preventDefault();
      const username = document.getElementById("loginUsername").value;
      const password = document.getElementById("loginPassword").value;
      const users = getUsers();
      const user = users.find(u => u.username === username && u.password === password);
      if (user) {
        currentUser = user;
        document.getElementById("userActions").innerHTML = `<span>Bienvenido, ${user.name}</span> <button onclick="logout()">Logout</button>`;
        updateProfileSummary();
        loadFeed();
        loadFriends();
        loadMessages();
        loadNotifications();
        updateSidebarSuggestions();
        updateOrderButtons();
        document.getElementById("createPostSection").style.display = "block";
        document.getElementById("sidebar").style.display = "block";
        document.getElementById("profileIconImg").src = currentUser.profilePic || "https://cdn-icons-png.flaticon.com/512/6326/6326055.png";
        closeModal("loginModal");
      } else {
        alert("Usuario o contraseña incorrectos.");
      }
    }
    
    function register(event) {
      event.preventDefault();
      const username = document.getElementById("regUsername").value;
      const password = document.getElementById("regPassword").value;
      const name = document.getElementById("regName").value;
      const bio = document.getElementById("regBio").value;
      let users = getUsers();
      if (users.find(u => u.username === username)) {
        alert("El nombre de usuario ya existe.");
        return;
      }
      const newUser = { 
        id: Date.now(), 
        username, 
        password, 
        name, 
        bio, 
        verified: false,
        friends: [], 
        friendRequests: [], 
        profilePic: "", 
        removedSuggestions: [], 
        createdAt: Date.now(),
        following: [],
        followers: []
      };
      users.push(newUser);
      saveUsers(users);
      alert("Registro exitoso. Ahora inicia sesión.");
      closeModal("registerModal");
    }
    
    function logout() {
      window.location.reload();
    }
    
    /***************************************
     * Actualización del Perfil Resumido y Configuración
     ***************************************/
    function updateProfileSummary() {
      if (currentUser) {
        document.getElementById("profileSummary").style.display = "block";
        document.getElementById("profilePic").src = currentUser.profilePic || "https://cdn-icons-png.flaticon.com/512/6326/6326055.png";
        document.getElementById("profileName").innerHTML = getUserDisplayName(currentUser);
        document.getElementById("profileBio").innerText = currentUser.bio;
        let followerCount = currentUser.followers ? currentUser.followers.length : 0;
        document.getElementById("profileFollowers").innerText = "Seguidores: " + followerCount;
      }
    }
    
    /***************************************
     * Gestión de Publicaciones y Feed
     ***************************************/
    function renderPost(post) {
      const users = getUsers();
      const postUser = users.find(u => u.id === post.userId);
      let defaultPic = "https://cdn-icons-png.flaticon.com/512/6326/6326055.png";
      let userPic = (postUser && postUser.profilePic) ? postUser.profilePic : defaultPic;
      
      let mediaHTML = "";
      if (post.mediaType === "imagen") {
        if (post.mediaFile) {
          mediaHTML = `<img src="${post.mediaFile}" alt="Imagen publicada" style="max-width:100%;">`;
        } else if (post.mediaURL) {
          mediaHTML = `<img src="${post.mediaURL}" alt="Imagen publicada" style="max-width:100%;">`;
        }
      }
      
      let deletePostBtn = "";
      if (currentUser && (post.userId === currentUser.id || currentUser.username.toUpperCase() === "MARIOGAMES")) {
        deletePostBtn = `<button class="btn btn-danger" onclick="deletePost(${post.id})">Eliminar</button>`;
      }
      
      let followBtn = "";
      if (currentUser && currentUser.id !== post.userId) {
        followBtn = `<button class="btn btn-primary" onclick="toggleFollow(${post.userId})">
                      ${ isFollowing(post.userId) ? "Dejar de seguir" : "Seguir" }
                     </button>`;
      }
      
      let commentsHTML = post.comments.map((c, index) => {
        let deleteCommentBtn = "";
        if (currentUser && (currentUser.username.toUpperCase() === "MARIOGAMES" ||
              c.userId === currentUser.id || post.userId === currentUser.id)) {
          deleteCommentBtn = `<button class="btn btn-danger" onclick="deleteComment(${post.id}, ${index})">Eliminar</button>`;
        }
        return `<p><strong>${c.userName}:</strong> ${c.text} ${deleteCommentBtn}</p>`;
      }).join("");
      
      return `
        <div class="post">
          <div class="post-header">
            <img src="${userPic}" alt="Foto de perfil">
            <strong>${postUser ? getUserDisplayName(postUser) : "Usuario"}</strong>
          </div>
          <h4>${post.title}</h4>
          <p>${post.description || ""}</p>
          ${mediaHTML}
          <div>
            <button class="btn btn-primary" onclick="likePost(${post.id})">
              Me Gusta (${post.likes.length})
            </button>
            ${ followBtn }
            <button class="btn btn-secondary" onclick="toggleCommentForm(${post.id})">
              Comentar
            </button>
            ${ deletePostBtn }
          </div>
          <!-- Comentarios y formulario ocultos por defecto -->
          <div id="comments-${post.id}" style="display:none;">
            ${commentsHTML}
          </div>
          <div id="commentForm-${post.id}" style="display:none;">
            <input type="text" id="commentInput-${post.id}" placeholder="Escribe un comentario">
            <button onclick="addComment(${post.id})">Enviar</button>
          </div>
        </div>
      `;
    }
    
    // Muestra/oculta comentarios y formulario al pulsar "Comentar"
    function toggleCommentForm(postId) {
      if (!currentUser) {
        alert("Debes iniciar sesión para usar esta funcionalidad");
        return;
      }
      const commentsDiv = document.getElementById(`comments-${postId}`);
      const formDiv = document.getElementById(`commentForm-${postId}`);
      if (commentsDiv.style.display === "none" || commentsDiv.style.display === "") {
        commentsDiv.style.display = "block";
        formDiv.style.display = "block";
      } else {
        commentsDiv.style.display = "none";
        formDiv.style.display = "none";
      }
    }
    
    function loadFeed() {
      const feedContainer = document.getElementById("feed");
      let posts = getPosts();
      let feedPosts = [];
      if (currentUser) {
        feedPosts = posts.slice();
        feedPosts.sort((a, b) => {
          let wA = (a.likes.includes(currentUser.id)) ? 10 : (currentUser.following && currentUser.following.includes(a.userId)) ? 20 : 70;
          let wB = (b.likes.includes(currentUser.id)) ? 10 : (currentUser.following && currentUser.following.includes(b.userId)) ? 20 : 70;
          let keyA = -Math.log(Math.random()) / wA;
          let keyB = -Math.log(Math.random()) / wB;
          return keyA - keyB;
        });
      } else {
        feedPosts = shuffleArray(posts.slice());
      }
      
      if (feedOrder === "mias") {
        feedPosts = feedPosts.filter(post => post.userId === currentUser.id);
        if (feedPosts.length === 0) {
          feedContainer.innerHTML = "<p>No se encontraron publicaciones. Publica tu primera publicación para poder usar este filtro.</p>";
          return;
        }
      }
      
      if (feedPosts.length === 0) {
        feedContainer.innerHTML = "<p>No hay más publicaciones en este momento. Vuelve a comprobarlo más tarde.</p>";
      } else {
        feedContainer.innerHTML = feedPosts.map(post => renderPost(post)).join("");
      }
      
      if (!currentUser) {
        document.getElementById("createPostSection").style.display = "none";
      }
      
      updateOrderButtons();
    }
    
    function setFeedOrder(order) {
      if (!currentUser) return;
      feedOrder = order;
      updateOrderButtons();
      loadFeed();
    }
    
    function updateOrderButtons() {
      const buttons = document.querySelectorAll("#feedOrderControls .order-btn");
      buttons.forEach(btn => {
        if (!currentUser) {
          btn.disabled = true;
          btn.classList.remove("active");
        } else {
          btn.disabled = false;
          if (btn.getAttribute("data-order") === feedOrder) {
            btn.classList.add("active");
          } else {
            btn.classList.remove("active");
          }
        }
      });
    }
    
    function likePost(postId) {
      if (!currentUser) {
        alert("Debes iniciar sesión para usar esta funcionalidad");
        return;
      }
      let posts = getPosts();
      const index = posts.findIndex(p => p.id === postId);
      if (index !== -1) {
        let post = posts[index];
        if (!post.likes.includes(currentUser.id)) {
          post.likes.push(currentUser.id);
        } else {
          post.likes = post.likes.filter(id => id !== currentUser.id);
        }
        posts[index] = post;
        savePosts(posts);
        loadFeed();
        updateSidebarSuggestions();
      }
    }
    
    function addComment(postId) {
      if (!currentUser) {
        alert("Debes iniciar sesión para usar esta funcionalidad");
        return;
      }
      const input = document.getElementById(`commentInput-${postId}`);
      const text = input.value;
      if (text.trim() === "") return;
      let posts = getPosts();
      const index = posts.findIndex(p => p.id === postId);
      if (index !== -1) {
        let post = posts[index];
        post.comments.push({ userId: currentUser.id, userName: currentUser.name, text, timestamp: Date.now() });
        posts[index] = post;
        savePosts(posts);
        loadFeed();
      }
    }
    
    function deletePost(postId) {
      if (!currentUser) return;
      let posts = getPosts();
      const index = posts.findIndex(p => p.id === postId);
      if (index !== -1) {
        if (posts[index].userId !== currentUser.id && currentUser.username.toUpperCase() !== "MARIOGAMES") {
          alert("No puedes eliminar esta publicación");
          return;
        }
        if (confirm("¿Estás seguro de que deseas eliminar esta publicación?")) {
          posts.splice(index, 1);
          savePosts(posts);
          loadFeed();
        }
      }
    }
    
    function deleteComment(postId, commentIndex) {
      if (!currentUser) return;
      let posts = getPosts();
      const index = posts.findIndex(p => p.id === postId);
      if (index !== -1) {
        let post = posts[index];
        if (!(currentUser.username.toUpperCase() === "MARIOGAMES" ||
              post.comments[commentIndex].userId === currentUser.id ||
              post.userId === currentUser.id)) {
          alert("No puedes eliminar este comentario");
          return;
        }
        if (confirm("¿Estás seguro de que deseas eliminar este comentario?")) {
          post.comments.splice(commentIndex, 1);
          posts[index] = post;
          savePosts(posts);
          loadFeed();
        }
      }
    }
    
    /***************************************
     * Publicar Nueva Publicación (solo imágenes)
     ***************************************/
    function checkPostFormValidity() {
      const title = document.getElementById("postTitle").value.trim();
      const description = document.getElementById("postDescription").value.trim();
      const mediaType = document.getElementById("postMediaType").value;
      const fileInput = document.getElementById("postFile");
      const publishButton = document.getElementById("publishButton");
      
      let valid = (title.length > 0 && title.length <= 50 && description.length > 0 && description.length <= 500);
      // Solo se permite la opción "imagen". Si se ha seleccionado "imagen", y se ha subido un archivo o se ha dejado vacío, se considera válido.
      if (mediaType === "imagen") {
        // Aquí se permite tanto subir un archivo como dejarlo sin subir.
        valid = valid; 
      }
      
      if (valid) {
        publishButton.disabled = false;
        publishButton.style.background = "#1877f2";
      } else {
        publishButton.disabled = true;
        publishButton.style.background = "black";
      }
    }
    
    document.getElementById("postTitle").addEventListener("input", checkPostFormValidity);
    document.getElementById("postDescription").addEventListener("input", checkPostFormValidity);
    
    document.getElementById("postMediaType").addEventListener("change", function() {
      const mediaType = this.value;
      const fileInput = document.getElementById("postFile");
      if (mediaType === "imagen") {
        fileInput.accept = "image/*";
      } else {
        fileInput.accept = "image/*";
      }
      checkPostFormValidity();
    });
    
    function publishPost() {
      if (!currentUser) {
        alert("Debes iniciar sesión para publicar");
        return;
      }
      const title = document.getElementById("postTitle").value.trim();
      const description = document.getElementById("postDescription").value.trim();
      const mediaType = document.getElementById("postMediaType").value;
      const mediaURL = document.getElementById("postMediaURL").value.trim();
      const fileInput = document.getElementById("postFile");
      const loadingIndicator = document.getElementById("loadingIndicator");
      
      // Como solo se permiten imágenes, ignoramos la opción de vídeo.
      loadingIndicator.style.display = "block";
      loadingIndicator.innerText = "Cargando...";
      
      function createNewPost(mediaData) {
        let posts = getPosts();
        const newPost = {
          id: Date.now(),
          userId: currentUser.id,
          title,
          description,
          mediaType,
          mediaFile: mediaData || "",
          mediaURL: mediaData ? "" : mediaURL,
          timestamp: Date.now(),
          likes: [],
          comments: []
        };
        posts.unshift(newPost);
        savePosts(posts);
        document.getElementById("postForm").reset();
        checkPostFormValidity();
        loadFeed();
        loadMyPosts();
        updateSidebarSuggestions();
        loadingIndicator.style.display = "none";
      }
      
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
          createNewPost(e.target.result);
        };
        reader.onerror = function(e) {
          alert("Error al cargar la imagen.");
          loadingIndicator.style.display = "none";
        };
        reader.readAsDataURL(file);
      } else {
        createNewPost(null);
      }
    }
    
    function loadMyPosts() {
      const myPostsContainer = document.getElementById("myPosts");
      if (!currentUser) return;
      let posts = getPosts();
      let myPosts = posts.filter(post => post.userId === currentUser.id)
                         .sort((a, b) => b.timestamp - a.timestamp);
      if (myPosts.length === 0) {
        myPostsContainer.innerHTML = "<p>No se encontraron publicaciones. Publica tu primera publicación para poder usar este filtro.</p>";
      } else {
        myPostsContainer.innerHTML = myPosts.map(post => renderPost(post)).join("");
      }
    }
    
    /***************************************
     * Actualización del Perfil y Configuración
     ***************************************/
    function updateProfile(event) {
      event.preventDefault();
      if (!currentUser) return;
      const newName = document.getElementById("editName").value.trim();
      const newBio = document.getElementById("editBio").value.trim();
      const newVerified = document.getElementById("editVerified").checked;
      let users = getUsers();
      const index = users.findIndex(u => u.id === currentUser.id);
      if (index !== -1) {
        users[index].name = newName;
        users[index].bio = newBio;
        users[index].verified = newVerified;
        currentUser = users[index];
        saveUsers(users);
        updateProfileSummary();
        updateProfileStats();
        alert("Perfil actualizado.");
      }
    }
    
    document.getElementById("profileImageInput").addEventListener("change", function(event) {
      if (!currentUser) {
        alert("Debes iniciar sesión para actualizar tu imagen de perfil.");
        return;
      }
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const dataURL = e.target.result;
          let users = getUsers();
          const index = users.findIndex(u => u.id === currentUser.id);
          if (index !== -1) {
            users[index].profilePic = dataURL;
            currentUser = users[index];
            saveUsers(users);
            updateProfileSummary();
            document.getElementById("profileIconImg").src = dataURL;
          }
        };
        reader.readAsDataURL(file);
      }
    });
    
    /***************************************
     * Funciones de "Seguir" en publicaciones
     ***************************************/
    function isFollowing(userId) {
      return currentUser && currentUser.following && currentUser.following.includes(userId);
    }
    
    function toggleFollow(userId) {
      if (!currentUser) { alert("Debes iniciar sesión para usar esta funcionalidad"); return; }
      let users = getUsers();
      let target = users.find(u => u.id === userId);
      if (!target) return;
      if (currentUser.following && currentUser.following.includes(userId)) {
        currentUser.following = currentUser.following.filter(id => id !== userId);
        if (target.followers) {
          target.followers = target.followers.filter(id => id !== currentUser.id);
        }
      } else {
        if (!currentUser.following) currentUser.following = [];
        currentUser.following.push(userId);
        if (!target.followers) target.followers = [];
        target.followers.push(currentUser.id);
      }
      let updatedUsers = users.map(u => {
        if (u.id === target.id) return target;
        if (u.id === currentUser.id) return currentUser;
        return u;
      });
      saveUsers(updatedUsers);
      updateProfileSummary();
      loadFeed();
    }
    
    /***************************************
     * Gestión de Amigos – Modificaciones para MARIOGAMES
     ***************************************/
    function loadFriends() {
      if (!currentUser) return;
      const users = getUsers();
      const friendItems = currentUser.friends.map(fid => {
        const friend = users.find(u => u.id === fid);
        if (!friend) return "";
        // Si el usuario actual es MARIOGAMES, se muestran 4 botones: Ver publicaciones, Enviar mensaje, Borrar y Banear.
        let extraButton = "";
        if (currentUser.username.toUpperCase() === "MARIOGAMES" && friend.username.toUpperCase() !== "MARIOGAMES") {
          extraButton = `<button onclick="banFriend(${friend.id})">Banear</button>`;
        }
        return `<li>
                  ${getUserDisplayName(friend)}<br>
                  <button onclick="viewFriendPosts(${friend.id})">Ver publicaciones</button>
                  <button onclick="sendFriendMessage(${friend.id})">Enviar mensaje</button>
                  <button onclick="deleteFriend(${friend.id})">Borrar</button>
                  ${extraButton}
                </li>`;
      }).join("");
      document.getElementById("friendsList").innerHTML = friendItems;
    }
    
    function viewFriendPosts(friendId) {
      const users = getUsers();
      const friend = users.find(u => u.id === friendId);
      if (!friend) return;
      let posts = getPosts().filter(post => post.userId === friendId)
                            .sort((a, b) => b.timestamp - a.timestamp);
      let html = `<h3>Publicaciones de ${getUserDisplayName(friend)}</h3>`;
      if (posts.length === 0) {
        html += "<p>Este amigo no ha publicado nada.</p>";
      } else {
        html += posts.map(post => renderPost(post)).join("");
      }
      document.getElementById("friendPosts").innerHTML = html;
    }
    
    function sendFriendMessage(friendId) {
      const users = getUsers();
      const friend = users.find(u => u.id === friendId);
      if (!friend) return;
      navigate("messages");
      document.getElementById("msgRecipient").value = friend.username;
    }
    
    function deleteFriend(friendId) {
      if (!currentUser) return;
      let users = getUsers();
      const friend = users.find(u => u.id === friendId);
      if (friend && friend.username.toUpperCase() === "MARIOGAMES") {
        alert("No puedes eliminar a MARIOGAMES de tus amigos.");
        return;
      }
      if (confirm("¿Estás seguro de que deseas eliminar a este amigo?")) {
        currentUser.friends = currentUser.friends.filter(fid => fid !== friendId);
        const friendIndex = users.findIndex(u => u.id === friendId);
        if (friendIndex !== -1) {
          users[friendIndex].friends = users[friendIndex].friends.filter(fid => fid !== currentUser.id);
        }
        const currentIndex = users.findIndex(u => u.id === currentUser.id);
        if (currentIndex !== -1) {
          users[currentIndex] = currentUser;
        }
        saveUsers(users);
        alert("Amigo eliminado.");
        loadFriends();
        updateSidebarSuggestions();
      }
    }
    
    // Si el usuario actual es MARIOGAMES, al enviar solicitud se establece la amistad de inmediato.
    function sendFriendRequestByUsername() {
      if (!currentUser) {
        alert("Debes iniciar sesión para usar esta funcionalidad");
        return;
      }
      const usernameInput = document.getElementById("friendRequestUsername");
      const username = usernameInput.value.trim();
      if (username === "") {
        alert("Por favor, ingresa un nombre de usuario");
        return;
      }
      let users = getUsers();
      const targetUser = users.find(u => u.username === username);
      if (!targetUser) {
        alert("Usuario no encontrado.");
        return;
      }
      if (targetUser.id === currentUser.id) {
        alert("No puedes enviarte una solicitud a ti mismo.");
        return;
      }
      // Si el usuario actual es MARIOGAMES, se establece la amistad inmediatamente.
      if (currentUser.username.toUpperCase() === "MARIOGAMES") {
        if (!currentUser.friends.includes(targetUser.id)) {
          currentUser.friends.push(targetUser.id);
        }
        if (!targetUser.friends.includes(currentUser.id)) {
          targetUser.friends.push(currentUser.id);
        }
        saveUsers(users);
        alert("Amistad establecida automáticamente.");
        usernameInput.value = "";
        loadFriends();
        updateSidebarSuggestions();
        return;
      }
      // Para otros usuarios se envía la solicitud de forma normal.
      if (currentUser.friends.includes(targetUser.id)) {
        alert("Ya eres amigo de este usuario.");
        return;
      }
      if (targetUser.friendRequests.includes(currentUser.id)) {
        alert("Ya has enviado una solicitud a este usuario.");
        return;
      }
      targetUser.friendRequests.push(currentUser.id);
      let notifications = getNotifications();
      notifications.push({ id: Date.now(), userId: targetUser.id, text: `Tienes una solicitud de amistad de ${currentUser.name}`, from: currentUser.id, timestamp: Date.now() });
      saveNotifications(notifications);
      let updatedUsers = users.map(u => u.id === targetUser.id ? targetUser : u);
      saveUsers(updatedUsers);
      alert("Solicitud de amistad enviada.");
      usernameInput.value = "";
    }
    
    /***************************************
     * Función para Banear (solo para MARIOGAMES)
     ***************************************/
    function banFriend(friendId) {
      if (!currentUser || currentUser.username.toUpperCase() !== "MARIOGAMES") return;
      let users = getUsers();
      const friend = users.find(u => u.id === friendId);
      if (!friend) return;
      if (confirm("¿Estás seguro de que deseas banear a este usuario? Esto eliminará su cuenta y todos sus datos.")) {
        deleteUserAccount(friendId);
        // Además, eliminamos la relación de amistad en MARIOGAMES.
        currentUser.friends = currentUser.friends.filter(fid => fid !== friendId);
        saveUsers(users);
        loadFriends();
      }
    }
    
    // Función para eliminar la cuenta de un usuario (usada para banear)
    function deleteUserAccount(userId) {
      let users = getUsers();
      users = users.filter(u => u.id !== userId);
      saveUsers(users);
      let posts = getPosts();
      posts = posts.filter(post => post.userId !== userId);
      savePosts(posts);
      let messages = getMessages();
      messages = messages.filter(m => m.from !== userId && m.to !== userId);
      saveMessages(messages);
      let notifications = getNotifications();
      notifications = notifications.filter(n => n.userId !== userId);
      saveNotifications(notifications);
      alert("La cuenta ha sido borrada.");
      loadFeed();
      loadFriends();
    }
    
    /***************************************
     * Amigos recomendados (basados en interacción)
     ***************************************/
    function updateSidebarSuggestions() {
      if (!currentUser) {
        document.getElementById("friendSuggestions").style.display = "none";
        return;
      }
      let posts = getPosts();
      let interactedUserIds = new Set();
      posts.forEach(post => {
        if (post.likes.includes(currentUser.id)) {
          interactedUserIds.add(post.userId);
        }
        post.comments.forEach(c => {
          if (c.userId === currentUser.id) {
            interactedUserIds.add(post.userId);
          }
        });
      });
      let suggestionsList = document.getElementById("suggestionsList");
      let noFriendsText = document.getElementById("noFriendsText");
      if (interactedUserIds.size === 0) {
        suggestionsList.innerHTML = "";
        noFriendsText.style.display = "block";
        noFriendsText.innerText = "Interactúa (Me Gusta o Comentar) en publicaciones para recibir recomendaciones.";
        return;
      }
      document.getElementById("friendSuggestions").style.display = "block";
      const users = getUsers();
      let recommendations = users.filter(u =>
        interactedUserIds.has(u.id) &&
        u.id !== currentUser.id &&
        !currentUser.friends.includes(u.id) &&
        !(currentUser.removedSuggestions && currentUser.removedSuggestions.includes(u.id))
      );
      if (recommendations.length === 0) {
        suggestionsList.innerHTML = "";
        noFriendsText.style.display = "block";
        noFriendsText.innerText = "No hay amigos disponibles. Explora publicaciones para obtener sugerencias.";
      } else {
        noFriendsText.style.display = "none";
        let displayRecs = recommendations;
        if (recommendations.length >= 50) {
          displayRecs = recommendations.slice(0,50);
          suggestionsList.innerHTML = displayRecs.map(u => `<li>
                    <button onclick="sendFriendRequestSuggestion(${u.id})">Enviar solicitud de amistad</button>
                    <button onclick="removeSuggestion(${u.id})">Eliminar sugerencia</button>
                    ${getUserDisplayName(u)}
                  </li>`).join("");
          suggestionsList.innerHTML += `<li style="font-size:0.8em; color:#666;">Ya no te van a aparecer más amigos recomendados. Borra sugerencias o añade amigos para conseguir más recomendaciones.</li>`;
        } else {
          suggestionsList.innerHTML = displayRecs.map(u => `<li>
                    <button onclick="sendFriendRequestSuggestion(${u.id})">Enviar solicitud de amistad</button>
                    <button onclick="removeSuggestion(${u.id})">Eliminar sugerencia</button>
                    ${getUserDisplayName(u)}
                  </li>`).join("");
        }
      }
    }
    
    function sendFriendRequestSuggestion(userId) {
      if (!currentUser) {
        alert("Debes iniciar sesión para usar esta funcionalidad");
        return;
      }
      let users = getUsers();
      const targetUser = users.find(u => u.id === userId);
      if (!targetUser) {
        alert("Usuario no encontrado.");
        return;
      }
      if (targetUser.id === currentUser.id) {
        alert("No puedes enviarte una solicitud a ti mismo.");
        return;
      }
      if (currentUser.friends.includes(targetUser.id)) {
        alert("Ya eres amigo de este usuario.");
        return;
      }
      if (targetUser.friendRequests.includes(currentUser.id)) {
        alert("Ya has enviado una solicitud a este usuario.");
        return;
      }
      targetUser.friendRequests.push(currentUser.id);
      let notifications = getNotifications();
      notifications.push({ id: Date.now(), userId: targetUser.id, text: `Tienes una solicitud de amistad de ${currentUser.name}`, from: currentUser.id, timestamp: Date.now() });
      saveNotifications(notifications);
      let updatedUsers = users.map(u => u.id === targetUser.id ? targetUser : u);
      saveUsers(updatedUsers);
      alert("Solicitud de amistad enviada.");
      updateSidebarSuggestions();
    }
    
    function removeSuggestion(userId) {
      if (!currentUser) return;
      if (!currentUser.removedSuggestions) currentUser.removedSuggestions = [];
      currentUser.removedSuggestions.push(userId);
      let users = getUsers();
      const currentIndex = users.findIndex(u => u.id === currentUser.id);
      if (currentIndex !== -1) {
        users[currentIndex] = currentUser;
      }
      saveUsers(users);
      updateSidebarSuggestions();
    }
    
    /***************************************
     * ACEPTAR / DENEGAR SOLICITUDES
     ***************************************/
    function acceptFriendRequest(notificationId) {
      let notifications = getNotifications();
      const notifIndex = notifications.findIndex(n => n.id === notificationId);
      if (notifIndex === -1) return;
      let notif = notifications[notifIndex];
      if (!notif.text.toLowerCase().includes("solicitud de amistad")) return;
      let senderId = notif.from;
      let users = getUsers();
      if (!currentUser.friends.includes(senderId)) {
        currentUser.friends.push(senderId);
      }
      let sender = users.find(u => u.id === senderId);
      if (sender && !sender.friends.includes(currentUser.id)) {
        sender.friends.push(currentUser.id);
      }
      currentUser.friendRequests = currentUser.friendRequests.filter(id => id !== senderId);
      notifications.splice(notifIndex, 1);
      saveNotifications(notifications);
      users = users.map(u => {
        if (u.id === currentUser.id) return currentUser;
        if (u.id === senderId) return sender;
        return u;
      });
      saveUsers(users);
      alert("Solicitud aceptada.");
      loadNotifications();
      loadFriends();
      updateSidebarSuggestions();
    }
    
    function denyFriendRequest(notificationId) {
      let notifications = getNotifications();
      const notifIndex = notifications.findIndex(n => n.id === notificationId);
      if (notifIndex === -1) return;
      let notif = notifications[notifIndex];
      if (!notif.text.toLowerCase().includes("solicitud de amistad")) return;
      let senderId = notif.from;
      currentUser.friendRequests = currentUser.friendRequests.filter(id => id !== senderId);
      notifications.splice(notifIndex, 1);
      saveNotifications(notifications);
      alert("Solicitud denegada.");
      loadNotifications();
      updateSidebarSuggestions();
    }
    
    /***************************************
     * Gestión de Mensajes
     ***************************************/
    function sendMessage(event) {
      event.preventDefault();
      if (!currentUser) {
        alert("Debes iniciar sesión para usar esta funcionalidad");
        return;
      }
      const recipientName = document.getElementById("msgRecipient").value.trim();
      const msgContent = document.getElementById("msgContent").value.trim();
      if (recipientName === "" || msgContent === "") return;
      let users = getUsers();
      const recipient = users.find(u => u.username === recipientName || u.name === recipientName);
      if (!recipient) {
        alert("Usuario destinatario no encontrado.");
        return;
      }
      let messages = getMessages();
      const newMessage = { id: Date.now(), from: currentUser.id, to: recipient.id, content: msgContent, timestamp: Date.now() };
      messages.push(newMessage);
      saveMessages(messages);
      alert("Mensaje enviado.");
      document.getElementById("msgRecipient").value = "";
      document.getElementById("msgContent").value = "";
      loadMessages();
      let notifications = getNotifications();
      notifications.push({ id: Date.now(), userId: recipient.id, text: `Tienes un nuevo mensaje de ${currentUser.name}`, timestamp: Date.now() });
      saveNotifications(notifications);
      loadNotifications();
    }
    
    function loadMessages() {
      if (!currentUser) return;
      const messages = getMessages();
      const users = getUsers();
      const userMessages = messages.filter(m => m.from === currentUser.id || m.to === currentUser.id);
      let messagesHTML = "";
      userMessages.forEach(m => {
        const sender = users.find(u => u.id === m.from);
        const recipient = users.find(u => u.id === m.to);
        let viewBtn = "";
        if (m.content.toLowerCase().includes("mensaje")) {
          viewBtn = `<button onclick="viewMessage(${m.id})">Ver mensaje</button>`;
        }
        messagesHTML += `<li>
          <strong>De:</strong> ${sender ? sender.name : "Desconocido"} 
          <strong>Para:</strong> ${recipient ? recipient.name : "Desconocido"}<br>
          ${m.content}
          ${viewBtn}
          <button onclick="deleteMessage(${m.id})">Eliminar</button>
        </li>`;
      });
      document.getElementById("messagesList").innerHTML = messagesHTML;
    }
    
    function deleteMessage(messageId) {
      if (!currentUser) return;
      let messages = getMessages();
      messages = messages.filter(m => m.id !== messageId);
      saveMessages(messages);
      loadMessages();
    }
    
    function viewMessage(messageId) {
      navigate("messages");
    }
    
    /***************************************
     * Gestión de Notificaciones
     ***************************************/
    function loadNotifications() {
      if (!currentUser) return;
      let notifications = getNotifications();
      const now = Date.now();
      const THIRTY_DAYS = 30 * 24 * 60 * 60 * 1000;
      notifications = notifications.filter(n => now - n.timestamp < THIRTY_DAYS);
      saveNotifications(notifications);
      const userNotifications = notifications.filter(n => n.userId === currentUser.id);
      let notificationsHTML = "";
      userNotifications.forEach(n => {
        let extraButtons = "";
        if (n.text.toLowerCase().includes("solicitud de amistad")) {
          extraButtons = `<button onclick="acceptFriendRequest(${n.id})">Aceptar</button>
                          <button onclick="denyFriendRequest(${n.id})">Denegar</button>`;
        }
        notificationsHTML += `<li>
          ${n.text} (${new Date(n.timestamp).toLocaleString()})
          ${extraButtons}
          <button onclick="deleteNotification(${n.id})">Eliminar</button>
        </li>`;
      });
      document.getElementById("notificationsList").innerHTML = notificationsHTML;
    }
    
    function deleteNotification(notificationId) {
      if (!currentUser) return;
      let notifications = getNotifications();
      notifications = notifications.filter(n => n.id !== notificationId);
      saveNotifications(notifications);
      loadNotifications();
    }
    
    /***************************************
     * ACEPTAR / DENEGAR SOLICITUDES
     ***************************************/
    function acceptFriendRequest(notificationId) {
      let notifications = getNotifications();
      const notifIndex = notifications.findIndex(n => n.id === notificationId);
      if (notifIndex === -1) return;
      let notif = notifications[notifIndex];
      if (!notif.text.toLowerCase().includes("solicitud de amistad")) return;
      let senderId = notif.from;
      let users = getUsers();
      if (!currentUser.friends.includes(senderId)) {
        currentUser.friends.push(senderId);
      }
      let sender = users.find(u => u.id === senderId);
      if (sender && !sender.friends.includes(currentUser.id)) {
        sender.friends.push(currentUser.id);
      }
      currentUser.friendRequests = currentUser.friendRequests.filter(id => id !== senderId);
      notifications.splice(notifIndex, 1);
      saveNotifications(notifications);
      users = users.map(u => {
        if (u.id === currentUser.id) return currentUser;
        if (u.id === senderId) return sender;
        return u;
      });
      saveUsers(users);
      alert("Solicitud aceptada.");
      loadNotifications();
      loadFriends();
      updateSidebarSuggestions();
    }
    
    function denyFriendRequest(notificationId) {
      let notifications = getNotifications();
      const notifIndex = notifications.findIndex(n => n.id === notificationId);
      if (notifIndex === -1) return;
      let notif = notifications[notifIndex];
      if (!notif.text.toLowerCase().includes("solicitud de amistad")) return;
      let senderId = notif.from;
      currentUser.friendRequests = currentUser.friendRequests.filter(id => id !== senderId);
      notifications.splice(notifIndex, 1);
      saveNotifications(notifications);
      alert("Solicitud denegada.");
      loadNotifications();
      updateSidebarSuggestions();
    }
    
    /***************************************
     * Estadísticas en el Perfil
     ***************************************/
    function updateProfileStats() {
      if (!currentUser) return;
      let posts = getPosts();
      let myPosts = posts.filter(post => post.userId === currentUser.id);
      let totalFollowers = currentUser.followers ? currentUser.followers.length : 0;
      let totalLikes = myPosts.reduce((sum, post) => sum + post.likes.length, 0);
      let totalComments = myPosts.reduce((sum, post) => sum + post.comments.length, 0);
      let totalPosts = myPosts.length;
      let totalFriends = currentUser.friends ? currentUser.friends.length : 0;
      
      let statsHTML = `
        <h3>Estadísticas</h3>
        <p>Seguidores: ${totalFollowers}</p>
        <p>Total de likes: ${totalLikes}</p>
        <p>Total de comentarios: ${totalComments}</p>
        <p>Total de publicaciones: ${totalPosts}</p>
        <p>Total de amigos: ${totalFriends}</p>
      `;
      document.getElementById("profileStats").innerHTML = statsHTML;
    }
    
    let currentCommentsPage = 0;
    const COMMENTS_PER_PAGE = 20;
    function toggleReceivedComments() {
      let div = document.getElementById("receivedComments");
      if (div.style.display === "none") {
        currentCommentsPage = 0;
        loadReceivedComments();
        div.style.display = "block";
      } else {
        div.style.display = "none";
      }
    }
    function loadReceivedComments() {
      if (!currentUser) return;
      let posts = getPosts();
      let myPosts = posts.filter(post => post.userId === currentUser.id);
      let comments = [];
      myPosts.forEach(post => {
        post.comments.forEach(c => {
          comments.push({ text: c.text, userName: c.userName, timestamp: c.timestamp });
        });
      });
      comments.sort((a, b) => b.timestamp - a.timestamp);
      let start = currentCommentsPage * COMMENTS_PER_PAGE;
      let end = start + COMMENTS_PER_PAGE;
      let commentsToShow = comments.slice(start, end);
      let html = commentsToShow.map(c => `<p><strong>${c.userName}:</strong> ${c.text} (${new Date(c.timestamp).toLocaleString()})</p>`).join("");
      if (end < comments.length) {
        html += `<button onclick="loadMoreComments()">Ver más</button>`;
      }
      document.getElementById("receivedComments").innerHTML = html;
    }
    function loadMoreComments() {
      currentCommentsPage++;
      loadReceivedComments();
    }
    
    function showFriends() {
      navigate("friends");
    }
    
    /***************************************
     * Dropdown de perfil y Opciones
     ***************************************/
    document.getElementById("profileIcon").addEventListener("click", function(){
      let dd = document.getElementById("profileDropdown");
      dd.style.display = (dd.style.display === "none" || dd.style.display === "") ? "block" : "none";
    });
    function closeDropdown() {
      document.getElementById("profileDropdown").style.display = "none";
    }
    function showProfileStatistics() {
      closeDropdown();
      updateProfileStats();
      document.getElementById("statsContent").innerHTML = document.getElementById("profileStats").innerHTML;
      openModal("statsModal");
    }
    function closeStatsModal() { closeModal("statsModal"); }
    function showConfiguration() {
      closeDropdown();
      openModal("configModal");
    }
    function closeConfigModal() { closeModal("configModal"); }
    function showThemeOptions() { openModal("themeModal"); }
    function closeThemeModal() { closeModal("themeModal"); }
    function setTheme(theme, notify) {
      if (theme === "dark") {
        document.body.classList.add("dark");
        document.body.classList.remove("light");
      } else if (theme === "light") {
        document.body.classList.add("light");
        document.body.classList.remove("dark");
      } else if (theme === "system") {
        if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
          document.body.classList.add("dark");
          document.body.classList.remove("light");
        } else {
          document.body.classList.add("light");
          document.body.classList.remove("dark");
        }
      }
      localStorage.setItem("theme", theme);
      if (notify) {
        alert("Tema actualizado a " + theme);
      }
    }
    function confirmDeleteAccount() {
      if (confirm("¿Estás seguro de que deseas borrar tu cuenta? Esto eliminará todos tus datos.")) {
        deleteAccount();
      }
    }
    function deleteAccount() {
      let users = getUsers();
      users = users.filter(u => u.id !== currentUser.id);
      saveUsers(users);
      let posts = getPosts();
      posts = posts.filter(post => post.userId !== currentUser.id);
      savePosts(posts);
      let messages = getMessages();
      messages = messages.filter(m => m.from !== currentUser.id && m.to !== currentUser.id);
      saveMessages(messages);
      let notifications = getNotifications();
      notifications = notifications.filter(n => n.userId !== currentUser.id);
      saveNotifications(notifications);
      alert("Cuenta borrada.");
      logout();
    }
    
    /***************************************
     * Inicialización de la Aplicación
     ***************************************/
    function initApp() {
      initData();
      loadFeed();
      loadFriends();
      loadMessages();
      loadNotifications();
      if (!currentUser) {
        document.getElementById("createPostSection").style.display = "none";
        document.getElementById("sidebar").style.display = "none";
        updateOrderButtons();
      }
    }
    
    window.onload = initApp;
  </script>
</body>
</html>
